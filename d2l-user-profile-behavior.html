<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../d2l-organization-hm-behavior/d2l-organization-hm-behavior.html">
<link rel="import" href="../d2l-hm-constants-behavior/d2l-hm-constants-behavior.html">

<script src="https://s.brightspace.com/lib/siren-parser/6.0.0/siren-parser.js"></script>
<script>
	'use strict';

	/* @polymerBehavior userProfileBehaviorImpl */
	var userProfileBehaviorImpl = {
		properties: {
			token: String,
			userUrl: String,
			_doneRequests: {
				type: Boolean,
				value: false
			},
			_backgroundColor: {
				type: String,
				observer: '_checkDoneRequests',
				value: ''
			},
			_backgroundUrl: {
				type: String,
				observer: '_checkDoneRequests',
				value: ''
			},
			_name: {
				type: String,
				observer: '_checkDoneRequests',
				value: ''
			}
		},
		_backgroundColor: '',
		_backgroundUrl: '',
		_enrollmentsUrl: '',
		_headers: '',
		_iconUrl: '',
		_institutionUrl: '',
		_name: '',
		_organizationImageUrl: '',
		_organizationsUrl: '',
		_previousUserCall: null,
		_themeUrl: '',
		_createIronAjaxRequest: function(request, url, headers, onResponse) {
			request = request || document.createElement('iron-ajax');
			request.url = url;
			request.headers = headers;
			this.listen(request, 'iron-ajax-response', onResponse);
			this.listen(request, 'iron-ajax-error', onResponse);
			return request;
		},
		_checkDoneRequests: function() {
			var backgroundExists = !!(this._backgroundUrl || this._backgroundColor);
			var backgroundNeeded = (this.options || {}).background;
			var doneRequests = (!backgroundNeeded || backgroundExists) && !!this._name;

			if (doneRequests) {
				if (this._backgroundUrl) {
					// preload the image a bit so after the fade-in it's hopefully loaded
					var self = this;
					var setLoaded = function() {
						self._doneRequests = true;
					};
					var imagePreloader = document.createElement('img');
					imagePreloader.addEventListener('load', setLoaded);
					imagePreloader.addEventListener('error', setLoaded);
					imagePreloader.setAttribute('src', self._backgroundUrl);
				}

				this._doneRequests = true;
			}
		},
		generateUserRequest: function(userUrl, token, options) {
			this._previousUserCall = this._previousUserCall || {};
			this.userUrl = userUrl || this.userUrl;
			this.token = token || this.token;
			this.options = options || {};
			this._doneRequests = false;

			if (
				this.userUrl &&
				this.token &&
				this.userUrl !== this._previousUserCall.userUrl &&
				this.token !== this._previousUserCall.token
			) {
				this._previousUserCall = { userUrl: this.userUrl, token: this.token };
				this._headers = {
					Authorization: 'Bearer ' + this.token,
					Accept: 'application/vnd.siren+json'
				};
				this._userRequest = this._createIronAjaxRequest(this._userRequest, this.userUrl, this._headers, '_onUserResponse');
				this._userRequest.generateRequest();
			}
		},
		_onUserResponse: function(response) {
			if (response.detail.status === 200) {
				var userResponse = window.D2L.Hypermedia.Siren.Parse(response.detail.xhr.response);
				this._name = (userResponse.getSubEntityByRel(this.HypermediaRels.displayName) || { properties: {} }).properties.name;
				var profile = userResponse.getSubEntityByRel(this.HypermediaRels.userProfile);
				if (profile) {
					var image = profile.getSubEntityByRel(this.HypermediaRels.profileImage);
					if (image.class.indexOf('default-image') > -1) {
						this._iconUrl = null;
					} else {
						this._iconUrl = (image.getLinkByRel(this.HypermediaRels.thumbnailAlternative) || {}).href;
					}
				}

				this._rootUrl = (userResponse.getLinkByRel(this.HypermediaRels.root) || {}).href;

				if (this.options.background) {
					this._enrollmentsUrl = (userResponse.getLinkByRel(this.HypermediaRels.myEnrollments) || {}).href;
					this._folioUrl = (userResponse.getLinkByRel(this.HypermediaRels.Folio.folio) || {}).href;
					if (this._folioUrl) {
						this._folioReqeust = this._createIronAjaxRequest(this._folioReqeust, this._folioUrl, this._headers, '_onFolioResponse');
						this._folioReqeust.generateRequest();
					} else {
						this._makeEnrollmentsRequest();
					}
				}
			}
		},
		_makeRootRequest: function() {
			if (this._rootUrl) {
				this._rootRequest = this._createIronAjaxRequest(this._rootRequest, this._rootUrl, this._headers, '_onRootResponse');
				this._rootRequest.generateRequest();
			}
		},
		_makeEnrollmentsRequest: function() {
			// currently only called if we need an image and we can't get one from folio
			if (this._enrollmentsUrl) {
				this._enrollmentsUrl += '?pageSize=2&orgUnitTypeId=3&embedDepth=1';
				this._enrollmentsRequest = this._createIronAjaxRequest(this._enrollmentsRequest, this._enrollmentsUrl, this._headers, '_onEnrollmentsResponse');
				this._enrollmentsRequest.generateRequest();
			} else {
				// No enrollments url, get the background color
				this._makeRootRequest();
			}
		},
		_onFolioResponse: function(response) {
			if (response.detail.status === 200) {
				var folioResponse = window.D2L.Hypermedia.Siren.Parse(response.detail.xhr.response);
				var tiles = (folioResponse.getSubEntitiesByRel(this.HypermediaRels.Folio.evidence));
				for (var i = 0; i < tiles.length; i++) {
					var content = tiles[i].getSubEntityByRel(this.HypermediaRels.Folio.contentItem);
					var type = content.properties.type;
					if (type === 'Jpg' && type !== 'Png') {
						this._backgroundUrl = content.properties.url;
						return;
					}
				}
			}

			// Since the folio request failed, try to get the enrollment image
			this._makeEnrollmentsRequest();
		},
		_onRootResponse: function(response) {
			if (response.detail.status === 200) {
				var rootResponse = window.D2L.Hypermedia.Siren.Parse(response.detail.xhr.response);
				this._institutionUrl = (rootResponse.getLinkByRel(this.HypermediaRels.organization) || {}).href;

				if (this._institutionUrl) {
					this._institutionRequest = this._createIronAjaxRequest(this._institutionRequest, this._institutionUrl, this._headers, '_onInstitutionResponse');
					this._institutionRequest.generateRequest();
				} else {
					this._backgroundColor = 'initial';
				}
			}
		},
		_onEnrollmentsResponse: function(response) {
			if (response.detail.status === 200) {
				var enrollmentsResponse = window.D2L.Hypermedia.Siren.Parse(response.detail.xhr.response);
				var enrollmentEntities = enrollmentsResponse.getSubEntitiesByRel(this.HypermediaRels.userEnrollment);

				if (enrollmentEntities.length === 1) {
					this._organizationsUrl = enrollmentEntities[0].getLinkByRel(this.HypermediaRels.organization).href;

					this._organizationsRequest = this._createIronAjaxRequest(this._organizationsRequest, this._organizationsUrl, this._headers, '_onOrganizationsResponse');
					this._organizationsRequest.generateRequest();
					return;
				}
			}

			// More than 1 enrollment, get the background color
			this._makeRootRequest();
		},
		_onInstitutionResponse: function(response) {
			if (response.detail.status === 200) {
				var institutionResponse = window.D2L.Hypermedia.Siren.Parse(response.detail.xhr.response);
				this._themeUrl = (institutionResponse.getLinkByRel(this.HypermediaRels.theme) || {}).href;

				if (this._themeUrl) {
					this._themeRequest = this._createIronAjaxRequest(this._themeRequest, this._themeUrl, this._headers, '_onThemeResponse');
					this._themeRequest.generateRequest();
					return;
				}
			}

			this._backgroundColor = 'initial';
		},
		_onOrganizationsResponse: function(response) {
			if (response.detail.status === 200) {
				var organizationsResponse = window.D2L.Hypermedia.Siren.Parse(response.detail.xhr.response);
				var imageLink = organizationsResponse.getSubEntityByClass( this.HypermediaClasses.courseImage.courseImage);

				if (imageLink) {
					this._organizationImageUrl = imageLink.href;
					this._organizationImageRequest = this._createIronAjaxRequest(this._organizationImageRequest, this._organizationImageUrl, this._headers, '_onOrganizationImageResponse');
					this._organizationImageRequest.generateRequest();
					return;
				}
			}

			// No organization image, get the background color
			this._makeRootRequest();
		},
		_onOrganizationImageResponse: function(response) {
			if (response.detail.status === 200) {
				var organizationImageResponse = window.D2L.Hypermedia.Siren.Parse(response.detail.xhr.response);
				var backgroundImages = this._getImageLinks(organizationImageResponse, this.HypermediaClasses.courseImage.wide);
				this._backgroundUrl = backgroundImages.highMin || backgroundImages.lowMax;
			} else {
				// image request failed, get the background color
				this._makeRootRequest();
			}
		},

		_onThemeResponse: function(response) {
			if (response.detail.status === 200) {
				var theme = window.D2L.Hypermedia.Siren.Parse(response.detail.xhr.response);

				if (theme.properties) {
					this._backgroundColor = theme.properties.BackgroundColor;
					return;
				}
			}

			this._backgroundColor = 'initial';
		}
	};

	window.D2L = window.D2L || {};
	/*
	* Behavior for user profile-related elements such as user-tile and user-switcher.
	* @polymerBehavior window.D2L.UserProfileBehavior
	*/
	window.D2L.UserProfileBehavior = [
		window.D2L.Hypermedia.OrganizationHMBehavior,
		window.D2L.Hypermedia.HMConstantsBehavior,
		userProfileBehaviorImpl
	];
</script>
